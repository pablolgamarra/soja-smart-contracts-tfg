%% UML de Componentes â€” Prototipo de Contrato Inteligente Blockchain (Soja)
%% Autor: P. Gamarra et al.

flowchart TB
    %% ==== ACTORES ====
    actorComprador["ðŸ‘¤ Comprador (Empresa)"]
    actorVendedor["ðŸ‘¤ Vendedor (Productor)"]

    %% ==== COMPONENTES ====
    subgraph FRONTEND_COMPRADOR["Frontend Comprador (Web App + Metamask)"]
        F1["Componente UI: Formulario de creaciÃ³n de contrato"]
        F2["MÃ³dulo Web3: Firma on-chain (Metamask)"]
        F3["MÃ³dulo de consulta: Listado y estado de contratos"]
    end

    subgraph FRONTEND_VENDEDOR["Frontend Vendedor (Web/Bot WhatsApp)"]
        V1["Componente UI: VisualizaciÃ³n de contrato"]
        V2["MÃ³dulo de autenticaciÃ³n: Ingreso de OTP"]
    end

    subgraph BACKEND["Backend Node.js (Express + Ethers.js)"]
        B1["Controlador REST API"]
        B2["Servicio de OTP: GeneraciÃ³n y verificaciÃ³n"]
        B3["MÃ³dulo de Firma Custodial: SignContractSeller()"]
        B4["IntegraciÃ³n externa: Servicio de mensajerÃ­a (WhatsApp API)"]
        B5["Base de Datos: Contratos + OTP"]
    end

    subgraph BLOCKCHAIN["Blockchain (Ethereum / BNB Testnet)"]
        C1["Smart Contract: GrainContract.sol (ERC-721)"]
        C2["Registro inmutable de contratos"]
        C3["Eventos: CreaciÃ³n, Firma, FinalizaciÃ³n"]
    end

    %% ==== CONEXIONES ====
    actorComprador -->|Crea contrato| F1
    F1 --> F2 -->|TransacciÃ³n createContract()| C1
    C1 -->|Evento 'ContractCreated'| B1
    B1 -->|Genera OTP| B2 -->|EnvÃ­a OTP| B4 --> V1

    actorVendedor -->|Recibe OTP y consulta contrato| V1 --> B1
    V2 -->|Verifica OTP| B2 -->|Firma vÃ¡lida| B3 -->|signContractSeller()| C1

    C1 -->|Actualiza estado| F3
    C3 -->|Eventos escuchados| B5
    B5 -->|Sincroniza datos| F3

    %% ==== NOTAS ====
    note right of C1
      - ERC-721 (NFT) representa contrato Ãºnico
      - Metadata en IPFS (condiciones, fecha, partes)
      - Compatible con modelo RWA
    end
